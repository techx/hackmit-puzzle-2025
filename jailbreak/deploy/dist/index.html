<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jailbreak</title>
    <style>
      :root {
        --neon-green: #39ff14;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "Roboto Mono", monospace;
        color: #eee;
        position: relative;
        background-color: #1a1d21;
        background-image: url("https://www.transparenttextures.com/patterns/asfalt-dark.png"),
          url("https://www.transparenttextures.com/patterns/black-linen.png"),
          repeating-linear-gradient(
            0deg,
            rgba(255, 255, 255, 0.05) 0,
            rgba(255, 255, 255, 0.05) 1px,
            transparent 1px,
            transparent 30px
          ),
          repeating-linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.05) 0,
            rgba(255, 255, 255, 0.05) 1px,
            transparent 1px,
            transparent 30px
          );
        background-size: auto, auto, 30px 30px, 30px 30px;
        background-blend-mode: overlay;
      }

      @keyframes saberGlowL {
        0%,
        100% {
          box-shadow: 100px 0 0 #f00, 200px 0 0 #f00, 300px 0 0 #f00,
            400px 0 0 #f00;
        }
        50% {
          box-shadow: 100px 0 8px rgba(255, 0, 0, 0.8),
            200px 0 8px rgba(255, 0, 0, 0.8), 300px 0 8px rgba(255, 0, 0, 0.8),
            400px 0 8px rgba(255, 0, 0, 0.8);
        }
      }
      @keyframes saberGlowR {
        0%,
        100% {
          box-shadow: -100px 0 0 #f00, -200px 0 0 #f00, -300px 0 0 #f00,
            -400px 0 0 #f00;
        }
        50% {
          box-shadow: -100px 0 8px rgba(255, 0, 0, 0.8),
            -200px 0 8px rgba(255, 0, 0, 0.8), -300px 0 8px rgba(255, 0, 0, 0.8),
            -400px 0 8px rgba(255, 0, 0, 0.8);
        }
      }

      body::before,
      body::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        width: 12px;
        background: #f00;
        z-index: 0;
      }
      body::before {
        left: 0;
        animation: saberGlowL 2s ease-in-out infinite;
      }
      body::after {
        right: 0;
        animation: saberGlowR 2s ease-in-out infinite;
      }

      /* 4. Layer content above bars */
      body > * {
        position: relative;
        z-index: 1;
      }

      #user-id-indicator {
        position: absolute;
        top: 0.5em;
        left: 0.5em;
        font-size: 0.9em;
        color: #ccc;
        text-shadow: 1px 1px 1px #000;
      }

      h1 {
        color: var(--neon-green) !important;
        text-shadow: 0 0 6px var(--neon-green), 0 0 12px rgba(57, 255, 20, 0.5);
        font-size: 3.5em;
      }

      h1::before {
        content: "âš ";
        color: var(--neon-green) !important;
        font-size: 2em;
        margin-right: 0.4em;
        position: relative;
        top: 0.1em !important;
      }

      .highlight {
        background: linear-gradient(145deg, #2a2d31, #1b1d20);
        border: 3px solid #333;
        border-radius: 4px;
        padding: 1rem;
        box-shadow: inset 0 0 10px #000;
        max-width: 500px;
      }

      .highlight .ch {
        color: #39ff14;
      }
      .highlight .nb {
        color: #ff0176;
      }
      .highlight .s2 {
        color: #f7ff00;
      }
      .highlight .s1 {
        color: #00f0ff;
      }
      .highlight .nv {
        color: #0d00ff;
      }
      .highlight .w {
        color: #888;
      }

      a {
        color: #ffcc00;
        text-decoration: underline;
        display: inline-block;
        margin: 2em 0;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 0.7em;              /* Less gap */
        width: 240px;            /* Smaller width */
        padding: 1em;            /* Less padding */
        background: #222529;
        border: 3px solid #444;  /* Thinner border */
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7); /* Slightly softer shadow */
      }

      label span.field-q {
        display: block;
        color: #e44;
        text-transform: uppercase;
        font-size: 0.9em;
        margin-bottom: 0.2em;
        letter-spacing: 0.05em;
      }
      input[type="text"] {
        padding: 0.6em;
        font-size: 1em;
        background: #1f2124;
        border: 2px inset #333;
        color: #ddd;
      }

      button {
        padding: 0.8em;
        font-size: 1.1em;
        background: #000;
        border: 2px solid #555;
        box-shadow: inset 0 0 5px #000, 0 0 5px rgba(0, 0, 0, 0.5);
        color: #f5f5f5;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      button:hover {
        cursor: pointer;
        background: #333;
      }

      #jailbreak-output {
        font-family: monospace;
        background: #111;
        color: #f33;
        padding: 1em;
        border: 2px solid #500;
        margin-top: 1em;
        display: none;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div id="user-id-indicator"></div>
    <h1>Jailbreak</h1>
    <div class="highlight">
      <pre><span></span><span class="ch">#!/usr/bin/env -iS bash</span>

<span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;VAR: &quot;</span>
<span class="nb">read</span><span class="w"> </span>VAR<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-cd<span class="w"> </span><span class="s1">&#39;a-zA-Z0-9&#39;</span><span class="o">)</span>
<span class="nb">printf</span><span class="w"> </span><span class="s2">&quot;VAL: &quot;</span>
<span class="nb">read</span><span class="w"> </span>VAL<span class="w"> </span>&lt;<span class="w"> </span>&lt;<span class="o">(</span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="o">)</span>
<span class="nb">declare</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">PTR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$VAR</span><span class="s2">&quot;</span>
<span class="nv">PTR</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$VAL</span><span class="s2">&quot;</span>
</pre>
    </div>
    <a href="/jailbreak.tar.gz">download exact deployment setup</a>
    <form id="jailbreak-form" action="#">
      <label for="varn">
        <span class="field-q">where to?</span>
      </label>
      <input type="text" placeholder="VAR" name="varn" required />
      <label for="val">
        <span class="field-q">what to do there?</span>
      </label>
      <input type="text" placeholder="VAL" name="val" required />
      <button type="submit">Attempt escape</button>
      <pre id="jailbreak-output"></pre>
    </form>

    <script>
      const form = document.getElementById("jailbreak-form");
      const output = document.getElementById("jailbreak-output");
      let ws;
      let outBuf = "";

      const cleanup = () => {
        console.log("cleanup");
        ws ? (ws.onclose = () => {}) : void 0;
        ws ? (ws.onerror = () => {}) : void 0;
        try {
          ws ? ws.close() : void 0;
        } catch {}
        ws = null;
        outBuf = "";
      };

      const submit = (userId, varn, val) => {
        cleanup();
        const host = location.host + "/ws/";
        // const host = "127.0.0.1:4300";
        ws = new WebSocket(
          `${location.protocol === "https:" ? "wss" : "ws"}://${host}`
        );
        ws.binaryType = "arraybuffer";

        ws.onmessage = (event) => {
          clearTimeout(ws.handshakeTimeout);
          const onMessageLogOutput = (event) => {
            let text;
            if (typeof event.data === "string") {
              text = event.data;
            } else {
              try {
                text = new TextDecoder().decode(event.data);
              } catch {
                cleanup();
                alert("failed to deserialize handshake message from server");
                return;
              }
            }
            console.log({ text });
            outBuf += text;
            output.innerText = outBuf;
            output.style.display = "block";
          };

          let text;
          if (typeof event.data === "string") {
            text = event.data;
          } else {
            try {
              text = new TextDecoder().decode(event.data);
            } catch {
              cleanup();
              alert("failed to deserialize handshake message from server");
              return;
            }
          }

          if (text.trim() != "user ID:") {
            cleanup();
            alert("received invalid handshake from server");
          }

          ws.submitTimeout = setTimeout(() => {
            cleanup();
            alert("timed out while submitting");
          }, 5000);
          ws.onmessage = () => {
            ws.onmessage = () => {
              ws.onmessage = onMessageLogOutput;
              ws.send(new TextEncoder().encode(val + "\n"));
              clearTimeout(ws.submitTimeout);
            };
            ws.send(new TextEncoder().encode(varn + "\n"));
          };
          ws.send(new TextEncoder().encode(userId + "\n"));
        };

        ws.onopen = () => {
          ws.handshakeTimeout = setTimeout(() => {
            cleanup();
            alert("timed out while waiting for server handshake");
          }, 5000);
        };

        ws.onerror = () => {
          cleanup();
          alert("error connecting to server");
        };
      };

      const main = (userId) => {
        const userIdIndicator = document.getElementById("user-id-indicator");
        userIdIndicator.innerText = `Logged in as ${userId}`;

        form.onsubmit = (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          const values = {};
          for (let [key, value] of formData.entries()) {
            values[key] = value;
          }
          const { varn, val } = values;
          if (
            typeof varn !== "string" ||
            !varn ||
            typeof val !== "string" ||
            !val
          )
            return;

          submit(userId, varn, val);
        };
      };

      const AUTH_PATH_REGEX = /^\/u\/([^/]+)$/;
      const path = location.pathname;
      if (path === "/") {
        const user_id = (localStorage.getItem("user_id") || "").trim();

        if (
          typeof user_id !== "string" ||
          !user_id ||
          user_id.indexOf("\n") != -1 ||
          user_id.indexOf(" ") != -1 ||
          user_id.indexOf("\r") != -1
        ) {
          window.location.href = "/unauthorized";
        }
        main(user_id);
      } else if (path === "/unauthorized") {
        const newBody = document.createElement("body");
        const heading = document.createElement("h1");
        heading.innerText = "Unauthorized";
        newBody.appendChild(heading);
        const p = document.createElement("p");
        p.innerText = "Please access this site through a direct link";
        newBody.appendChild(p);
        document.body.replaceWith(newBody);
      } else if (path.match(AUTH_PATH_REGEX) !== null) {
        const match = path.match(AUTH_PATH_REGEX);
        console.log({ match });
        const user_id = match[1];
        localStorage.setItem("user_id", user_id);
        window.location.href = "/";
      } else {
        const newBody = document.createElement("body");
        const p = document.createElement("p");
        p.innerText = "Not Found";
        newBody.appendChild(p);
        document.body.replaceWith(newBody);
      }
    </script>
  </body>
</html>
